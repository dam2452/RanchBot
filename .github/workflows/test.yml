name: Common Test Workflow

on:
  workflow_call:

jobs:
  build:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}
      - name: Build & Push Docker Image
        run: |
          BRANCH=${GITHUB_REF##*/}
          docker build -t ${{ secrets.REGISTRY_URL }}/myapp:${BRANCH} -t ${{ secrets.REGISTRY_URL }}/myapp:test .
          docker push ${{ secrets.REGISTRY_URL }}/myapp:${BRANCH}
          docker push ${{ secrets.REGISTRY_URL }}/myapp:test

  deploy_test:
    runs-on: self-hosted
    needs: [build]
    steps:
      - name: Deploy Test Environment
        run: docker compose -f docker-compose.test.yml --project-name bot-test up -d

  run_tests:
    runs-on: self-hosted
    needs: [deploy_test]
    steps:
      - name: Run Placeholder Tests
        run: echo "hello world"
